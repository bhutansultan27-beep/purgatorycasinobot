<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <link rel="manifest" href="/static/manifest.json">
    <meta name="theme-color" content="#0d0d0f">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Gild Tesoro">
    <link rel="apple-touch-icon" href="/static/images/logo.png">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Hi-Lo - Gild Tesoro Casino</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="/static/css/casino.css">
    <style>
        .card-display {
            background: linear-gradient(135deg, #0d4d2b 0%, #0f5c33 100%);
            border: 4px solid var(--gold-dark);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            display: flex;
            justify-content: center;
            gap: 20px;
        }
        .playing-card {
            width: 80px;
            height: 120px;
            background: white;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: 700;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        }
        .playing-card.red { color: #cc0000; }
        .playing-card.black { color: #000; }
        .card-rank { font-size: 28px; }
        .card-suit { font-size: 32px; }
        .info-bar {
            display: flex;
            justify-content: space-around;
            background: var(--black-card);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .info-item { text-align: center; }
        .info-label { font-size: 10px; color: var(--gray); }
        .info-value { font-size: 18px; font-weight: 700; color: var(--gold); }
        .choice-buttons {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }
        .choice-btn {
            flex: 1;
            padding: 20px;
            border: none;
            border-radius: 15px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }
        .choice-btn.hi { background: linear-gradient(135deg, #44cc44 0%, #228822 100%); color: white; }
        .choice-btn.lo { background: linear-gradient(135deg, #ff4444 0%, #cc0000 100%); color: white; }
        .choice-btn.skip { background: var(--black); border: 1px solid var(--gray-dark); color: var(--white); }
        .choice-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .mult-hint { font-size: 12px; opacity: 0.8; }
        .controls {
            background: var(--black-card);
            border-radius: 15px;
            padding: 15px;
        }
        .bet-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .bet-input { width: 100px; padding: 10px; background: var(--black); border: 1px solid var(--gray-dark); border-radius: 8px; color: var(--white); text-align: center; }
        .action-btns { display: flex; gap: 10px; }
        .start-btn, .cashout-btn { flex: 1; padding: 15px; border: none; border-radius: 12px; font-weight: 700; cursor: pointer; }
        .start-btn { background: linear-gradient(135deg, var(--gold) 0%, var(--gold-dark) 100%); color: var(--black); }
        .cashout-btn { background: linear-gradient(135deg, #44cc44 0%, #228822 100%); color: white; display: none; }
    </style>
</head>
<body>
    <div class="container">
        <a href="/" class="back-button">← Menu</a>
        <header class="header">
            <div class="logo">
                <div class="logo-icon">⬆️⬇️</div>
                <span class="logo-text">HI-LO</span>
            </div>
            <div class="balance-display">
                <span class="balance-amount" id="balance">$0.00</span>
            </div>
        </header>

        <div class="card-display">
            <div class="playing-card" id="current-card">
                <div class="card-rank">?</div>
                <div class="card-suit">?</div>
            </div>
        </div>

        <div class="info-bar">
            <div class="info-item">
                <div class="info-label">Round</div>
                <div class="info-value" id="round">0</div>
            </div>
            <div class="info-item">
                <div class="info-label">Multiplier</div>
                <div class="info-value" id="multiplier">1.00x</div>
            </div>
            <div class="info-item">
                <div class="info-label">Potential</div>
                <div class="info-value" id="potential">$0.00</div>
            </div>
        </div>

        <div class="choice-buttons" id="choices" style="display: none;">
            <button class="choice-btn hi" onclick="guess('hi')">
                <span>⬆️ HIGHER</span>
                <span class="mult-hint" id="hi-mult">1.5x</span>
            </button>
            <button class="choice-btn skip" onclick="guess('skip')">
                <span>= SKIP</span>
                <span class="mult-hint">1.0x</span>
            </button>
            <button class="choice-btn lo" onclick="guess('lo')">
                <span>⬇️ LOWER</span>
                <span class="mult-hint" id="lo-mult">1.5x</span>
            </button>
        </div>

        <div class="controls">
            <div class="bet-row">
                <label>Bet Amount</label>
                <input type="number" class="bet-input" id="bet-amount" value="10" min="1">
            </div>
            <div class="action-btns">
                <button class="start-btn" id="start-btn" onclick="startGame()">Start Game</button>
                <button class="cashout-btn" id="cashout-btn" onclick="cashout()">Cash Out</button>
            </div>
        </div>
    </div>

    <script>
        let tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        const ranks = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'];
        const suits = ['♠', '♥', '♦', '♣'];
        
        let balance = 0;
        
        document.addEventListener('DOMContentLoaded', loadUserBalance);
        
        function loadUserBalance() {
            const initData = tg.initData || '';
            fetch('/api/user', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ initData: initData })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.user) {
                    balance = data.user.balance || 0;
                    updateBalance();
                }
            })
            .catch(error => console.error('Error loading balance:', error));
        }
        let currentBet = 0;
        let currentCard = null;
        let currentMultiplier = 1.00;
        let round = 0;
        let gameActive = false;

        function getCardValue(rank) {
            if (rank === 'A') return 1;
            if (['J', 'Q', 'K'].includes(rank)) return [11, 12, 13][['J', 'Q', 'K'].indexOf(rank)];
            return parseInt(rank);
        }

        function drawCard() {
            return {
                rank: ranks[Math.floor(Math.random() * ranks.length)],
                suit: suits[Math.floor(Math.random() * suits.length)]
            };
        }

        function displayCard(card) {
            const el = document.getElementById('current-card');
            el.innerHTML = `<div class="card-rank">${card.rank}</div><div class="card-suit">${card.suit}</div>`;
            el.className = 'playing-card ' + (['♥', '♦'].includes(card.suit) ? 'red' : 'black');
        }

        function startGame() {
            currentBet = parseFloat(document.getElementById('bet-amount').value);
            if (currentBet > balance) {
                alert('Insufficient balance!');
                return;
            }
            
            balance -= currentBet;
            updateBalance();
            
            gameActive = true;
            round = 1;
            currentMultiplier = 1.00;
            
            currentCard = drawCard();
            displayCard(currentCard);
            updateInfo();
            updateMultipliers();
            
            document.getElementById('start-btn').style.display = 'none';
            document.getElementById('cashout-btn').style.display = 'block';
            document.getElementById('choices').style.display = 'flex';
        }

        function guess(choice) {
            if (!gameActive) return;
            
            const oldValue = getCardValue(currentCard.rank);
            const newCard = drawCard();
            const newValue = getCardValue(newCard.rank);
            
            let correct = false;
            if (choice === 'hi') correct = newValue > oldValue;
            else if (choice === 'lo') correct = newValue < oldValue;
            else if (choice === 'skip') correct = true;
            
            displayCard(newCard);
            currentCard = newCard;
            
            if (correct) {
                if (choice !== 'skip') {
                    const mult = choice === 'hi' ? getHiMultiplier(oldValue) : getLoMultiplier(oldValue);
                    currentMultiplier *= mult;
                }
                round++;
                updateInfo();
                updateMultipliers();
            } else {
                gameActive = false;
                document.getElementById('choices').style.display = 'none';
                document.getElementById('cashout-btn').style.display = 'none';
                document.getElementById('start-btn').style.display = 'block';
                alert('Wrong guess! You lost $' + currentBet.toFixed(2));
            }
        }

        function getHiMultiplier(value) {
            const higher = 13 - value;
            return higher > 0 ? Math.max(1.01, (13 / higher) * 0.95) : 13;
        }

        function getLoMultiplier(value) {
            const lower = value - 1;
            return lower > 0 ? Math.max(1.01, (13 / lower) * 0.95) : 13;
        }

        function updateMultipliers() {
            const value = getCardValue(currentCard.rank);
            document.getElementById('hi-mult').textContent = getHiMultiplier(value).toFixed(2) + 'x';
            document.getElementById('lo-mult').textContent = getLoMultiplier(value).toFixed(2) + 'x';
        }

        function cashout() {
            if (!gameActive) return;
            
            const win = currentBet * currentMultiplier;
            balance += win;
            updateBalance();
            
            gameActive = false;
            document.getElementById('choices').style.display = 'none';
            document.getElementById('cashout-btn').style.display = 'none';
            document.getElementById('start-btn').style.display = 'block';
            
            alert('Cashed out $' + win.toFixed(2) + '!');
        }

        function updateInfo() {
            document.getElementById('round').textContent = round;
            document.getElementById('multiplier').textContent = currentMultiplier.toFixed(2) + 'x';
            document.getElementById('potential').textContent = '$' + (currentBet * currentMultiplier).toFixed(2);
        }

        function updateBalance() {
            document.getElementById('balance').textContent = '$' + balance.toLocaleString('en-US', { minimumFractionDigits: 2 });
        }
    </script>
</body>
</html>
